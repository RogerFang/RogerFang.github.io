---
title: 'Tomcat(3): 初始化和启动概述'
date: 2017-01-22 14:10:34
categories:
- tomcat
---

想要了解 Tomcat 的启动和初始化过程，就应该从启动入口`org.apache.catalina.startup.Bootstrap`类开始。

# main()
Bootstrap类的`main()`方法中，主要的任务是：
1. 实例化Bootstrap对象，并调用其`init()`方法
2. 如果传入的命令是启动Tomcat，则调用其`load()`和`start()`方法。

传入的命令参数`startd`和`start`的区别是设置了一个布尔变量`await`为`true`。

```java Boostrap.java
public static void main(String args[]) {

    if (daemon == null) {
        // Don't set daemon until init() has completed
        Bootstrap bootstrap = new Bootstrap();
        try {
            bootstrap.init();
        } catch (Throwable t) {
            handleThrowable(t);
            t.printStackTrace();
            return;
        }
        daemon = bootstrap;
    } else {
        Thread.currentThread().setContextClassLoader(daemon.catalinaLoader);
    }

    try {
        String command = "start";
        if (args.length > 0) {
            command = args[args.length - 1];
        }

        if (command.equals("startd")) {
            args[args.length - 1] = "start";
            daemon.load(args);
            daemon.start();
        } else if (command.equals("stopd")) {
            args[args.length - 1] = "stop";
            daemon.stop();
        } else if (command.equals("start")) {
            daemon.setAwait(true);
            daemon.load(args);
            daemon.start();
        } else if (command.equals("stop")) {
            daemon.stopServer(args);
        } else if (command.equals("configtest")) {
            daemon.load(args);
            if (null==daemon.getServer()) {
                System.exit(1);
            }
            System.exit(0);
        } else {
            log.warn("Bootstrap: command \"" + command + "\" does not exist.");
        }
    } catch (Throwable t) {
        // Unwrap the Exception for clearer error reporting
        if (t instanceof InvocationTargetException &&
                t.getCause() != null) {
            t = t.getCause();
        }
        handleThrowable(t);
        t.printStackTrace();
        System.exit(1);
    }

}
```

# 初始化
## 静态块
静态块的主要任务是初始化路径：
* HOME 路径：代表 Tomcat 的安装目录
* BASE 路径：代表 Tomcat 的工作目录。
> 如果想要运行Tomcat 的 多个实例，但是不想安装多个Tomcat软件副本。那么可以配置多个工作目录，每个运行实例独占一个工作目录，但是共享同一个安装目录。


## init()
Bootstrap的`init()`的主要任务是：
1. **初始化类加载器**
Tomcat类加载器：commonLoader、catalinaLoader、sharedLoader。
![](/images/tomcat/tomcat-classloader.png)

2. 主线程的classLoader设置为catalinaLoader，安全管理的classLoad设置为catalineLoader。

3. **初始化Bootstrap的`Catalina`对象**
	通过反射生成Catalina对象，并通过反射调用setParentClassLoader方法设置其父 ClassLoader为sharedLoader。


```java Boostrap.java
public void init() throws Exception {
	// 初始化Tomcat的类加载器
    initClassLoaders();

    Thread.currentThread().setContextClassLoader(catalinaLoader);

    SecurityClassLoad.securityClassLoad(catalinaLoader);

    // Load our startup class and call its process() method
    if (log.isDebugEnabled())
        log.debug("Loading startup class");
	// 初始化Catalina对象
    Class<?> startupClass =
        catalinaLoader.loadClass
        ("org.apache.catalina.startup.Catalina");
    Object startupInstance = startupClass.newInstance();

    // Set the shared extensions class loader
    if (log.isDebugEnabled())
        log.debug("Setting startup class properties");
    String methodName = "setParentClassLoader";
    Class<?> paramTypes[] = new Class[1];
    paramTypes[0] = Class.forName("java.lang.ClassLoader");
    Object paramValues[] = new Object[1];
    paramValues[0] = sharedLoader;
    Method method =
        startupInstance.getClass().getMethod(methodName, paramTypes);
    method.invoke(startupInstance, paramValues);

    catalinaDaemon = startupInstance;

}
```

# load()
Bootstrap的`load()`方法通过反射调用`Catalina`对象的`load()`方法。

`Catalina`的`load()`方法主要任务是：
1. 初始化命名服务的基本配置
2. 创建一个Digester类对象，默认用于解析`conf/server.xml`，将xml文件转换成相应的对象。
3. 调用`Server`的`init()`方法。

```xml conf/server.xml
<?xml version='1.0' encoding='utf-8'?>

<Server port="8005" shutdown="SHUTDOWN">
    ……
  <Service name="Catalina">
    <Connector port="8080" protocol="HTTP/1.1"
               connectionTimeout="20000"
               redirectPort="8443" />
    <Connector port="8009" protocol="AJP/1.3" redirectPort="8443" />
    <Engine name="Catalina" defaultHost="localhost">
      <Realm className="org.apache.catalina.realm.LockOutRealm">
        <Realm className="org.apache.catalina.realm.UserDatabaseRealm"
               resourceName="UserDatabase"/>
      </Realm>

      <Host name="localhost"  appBase="webapps"
            unpackWARs="true" autoDeploy="true">
        <Valve className="org.apache.catalina.valves.AccessLogValve" directory="logs"
               prefix="localhost_access_log." suffix=".txt"
               pattern="%h %l %u %t &quot;%r&quot; %s %b" />
      </Host>
    </Engine>
  </Service>
</Server>
```

# start()
Bootstrap的`start()`方法通过反射调用`Catalina`对象的`start()`方法。

`Catalina`的`start()`方法主要任务是：
1. 调用`Server`的`start()`方法。
2. 注册`shutdown`的钩子

```java Catalina.java
public void start() {

    if (getServer() == null) {
        load();
    }

    if (getServer() == null) {
        log.fatal("Cannot start server. Server instance is not configured.");
        return;
    }

    long t1 = System.nanoTime();

    // Start the new server
    try {
        getServer().start();
    } catch (LifecycleException e) {
        log.fatal(sm.getString("catalina.serverStartFail"), e);
        try {
            getServer().destroy();
        } catch (LifecycleException e1) {
            log.debug("destroy() failed for failed Server ", e1);
        }
        return;
    }

    long t2 = System.nanoTime();
    if(log.isInfoEnabled()) {
        log.info("Server startup in " + ((t2 - t1) / 1000000) + " ms");
    }

    // Register shutdown hook
    if (useShutdownHook) {
        if (shutdownHook == null) {
            shutdownHook = new CatalinaShutdownHook();
        }
        Runtime.getRuntime().addShutdownHook(shutdownHook);

        LogManager logManager = LogManager.getLogManager();
        if (logManager instanceof ClassLoaderLogManager) {
            ((ClassLoaderLogManager) logManager).setUseShutdownHook(
                    false);
        }
    }

    if (await) {
        await();
        stop();
    }
}
```

* * *
感谢：
阿里技术专家，楚岩：[Tomcat源码分析系列博客](https://yq.aliyun.com/tags/type_blog-tagid_2702/?spm=5176.8091938.0.0.FiZvcG)
