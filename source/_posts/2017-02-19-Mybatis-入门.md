---
title: 'Mybatis: 入门'
date: 2017-02-19 14:21:08
categories:
- Mybatis
---

# 简介
**Mybatis**框架的核心组成部分：mybatis-config.xml、SqlSession、Executor、StatementHandler、ResultSetHandler。
![](/images/mybatis/mybatis-framework.png)

## 配置文件
Mybatis的全局配置文件 mybatis-config.xml，配置的内容有：
* properties(属性)
	先解析其子节点`<property>`属性，再解析`resource`属性，后者会覆盖前者。
* settings(全局配置参数)
* typeAliases(类型别名)
* typeHandlers(类型处理器)
* objectFactory(对象工厂)
* plugins(插件)
* environments(环境集合属性对象)
	* environment(环境子属性对象)
		* transactionManager(事务管理)
		* dataSource(数据源)
* mappers(映射器)

具体参见：[Mybatis3](http://www.mybatis.org/mybatis-3/zh/)

## SqlSession
Mybatis的程序入口是`SqlSessionFactoryBuilder`，它的作用是通过`mybatis-config.xml`配置文件创建`Configuration`对象，然后通过`build()`方法创建`SqlSessionFactory`对象，而`SqlSessionFactory`主要功能是创建`SqlSession`对象。

`SqlSession`对象的主要功能是完成一次数据库的访问和结果的映射，不是线程安全的。`SqlSession`对数据库的操作都是通过`Executor`来完成的。

`SqlSession`对象的`getMapper()`方法，Mybatis会根据传入的接口类型和对应的XML配置文件生成一个**代理对象**（Mapper对象）。通过这个Mapper对象就可以访问`SqlSession`对象，然后执行相应的sql操作。

## Executor
`Executor`是在调用`SqlSessionFactory`的`openSession()`过程中被创建的，默认创建的类型是`SimpleExecutor`，`Executor`对象的主要功能是调用`StatementHandler`访问数据库。
```java DefaultSessionFactory
private SqlSession openSessionFromDataSource(ExecutorType execType, TransactionIsolationLevel level, boolean autoCommit) {
  ...
  final Executor executor = configuration.newExecutor(tx, execType);
  return new DefaultSqlSession(configuration, executor, autoCommit);
}
```

```java Configuration
public Executor newExecutor(Transaction transaction, ExecutorType executorType) {
    executorType = executorType == null ? defaultExecutorType : executorType;
    executorType = executorType == null ? ExecutorType.SIMPLE : executorType;
    Executor executor;
    if (ExecutorType.BATCH == executorType) {
      executor = new BatchExecutor(this, transaction);
    } else if (ExecutorType.REUSE == executorType) {
      executor = new ReuseExecutor(this, transaction);
    } else {
      executor = new SimpleExecutor(this, transaction);
    }
    // 默认为true
    if (cacheEnabled) {
      executor = new CachingExecutor(executor);
    }
    executor = (Executor) interceptorChain.pluginAll(executor);
    return executor;
}
```

## StatementHandler
`StatementHandler`是真正访问数据库的地方，在进行sql操作后，会调用`ResultSetHandler`处理查询结果。

# 实例
## PO
```java Actor.java
package model;

import java.util.Date;

public class Actor {
    private Short actorId;

    private String firstName;

    private String lastName;

    private Date lastUpdate;

    public Short getActorId() {
        return actorId;
    }

    public void setActorId(Short actorId) {
        this.actorId = actorId;
    }

    public String getFirstName() {
        return firstName;
    }

    public void setFirstName(String firstName) {
        this.firstName = firstName == null ? null : firstName.trim();
    }

    public String getLastName() {
        return lastName;
    }

    public void setLastName(String lastName) {
        this.lastName = lastName == null ? null : lastName.trim();
    }

    public Date getLastUpdate() {
        return lastUpdate;
    }

    public void setLastUpdate(Date lastUpdate) {
        this.lastUpdate = lastUpdate;
    }

    @Override
    public String toString() {
        return "Actor{" +
                "actorId=" + actorId +
                ", firstName='" + firstName + '\'' +
                ", lastName='" + lastName + '\'' +
                ", lastUpdate=" + lastUpdate +
                '}';
    }
}
```

## 映射文件
```java ActorMapper.xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dao.ActorMapper">
  <resultMap id="BaseResultMap" type="model.Actor">
    <id column="actor_id" jdbcType="SMALLINT" property="actorId" />
    <result column="first_name" jdbcType="VARCHAR" property="firstName" />
    <result column="last_name" jdbcType="VARCHAR" property="lastName" />
    <result column="last_update" jdbcType="TIMESTAMP" property="lastUpdate" />
  </resultMap>
  <sql id="Base_Column_List">
    actor_id, first_name, last_name, last_update
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Short" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from actor
    where actor_id = #{actorId,jdbcType=SMALLINT}
  </select>
</mapper>
```

## dao接口
Mybatis会根据接口实现相应的代理对象。
```java ActorMapper.java
package dao;

import model.Actor;

public interface ActorMapper {

    Actor selectByPrimaryKey(Short actorId);
}
```

## 配置文件
```java mybatis-config.xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    
    <properties resource="config.properties"/>
    
    <environments default="development">
        <environment id="development">
            <transactionManager type="JDBC"/>
            <dataSource type="POOLED">
                <property name="driver" value="${jdbc.driver}"/>
                <property name="url" value="${jdbc.url}"/>
                <property name="username" value="${jdbc.username}"/>
                <property name="password" value="${jdbc.password}"/>
            </dataSource>
        </environment>
    </environments>

    <mappers>
        <mapper resource="mapper/ActorMapper.xml"/>
    </mappers>
</configuration>
```

## 测试
```java
String resource = "mybatis-config.xml";
Reader reader = Resources.getResourceAsReader(resource);
SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(reader);

SqlSession session = factory.openSession();
ActorMapper mapper = session.getMapper(ActorMapper.class);
Actor actor = mapper.selectByPrimaryKey((short) 1);
System.out.println(actor);
session.close();
```

# Mybatis和Hibernate
**Hibernate**：标准的ORM框架，自动生成sql语句，对sql语句进行优化、修改较困难。

**Mybatis**：一个不完全的ORM框架，专注sql本身，程序员自己维护sql语句，sql修改优化比较方便。
